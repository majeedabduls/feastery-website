<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Feastery — Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    .card { transition: box-shadow .15s ease; }
    .card:hover { box-shadow: 0 8px 30px rgba(16,24,40,.08); }
  </style>
</head>

<body class="bg-gray-50 min-h-screen text-slate-800">

  <!-- HEADER -->
   <script>
  if (localStorage.getItem("feastery_admin") !== "logged") {
    window.location.href = "admin-login.html";
  }
</script>

  <header class="bg-white shadow">
    <div class="max-w-6xl mx-auto px-6 py-5 flex items-center justify-between">
      <div>
        <h1 class="text-2xl font-extrabold text-emerald-700">Feastery Admin</h1>
        <p class="text-sm text-slate-500">Manage products, orders & users</p>
      </div>
      <div class="flex gap-3 items-center">
        <button id="refreshBtn" class="bg-emerald-600 text-white px-4 py-2 rounded-md hover:bg-emerald-700">
          Refresh
        </button>
        <a href="/" class="text-sm text-slate-600 hover:underline">Open Store →</a>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-6 py-8 grid gap-8 lg:grid-cols-2">

    <!-- PRODUCT FORM -->
    <section class="bg-white p-6 rounded-2xl shadow-sm">
      <h2 id="formTitle" class="text-lg font-semibold mb-4">Add New Product</h2>

      <form id="productForm" class="space-y-4">
        <input type="hidden" id="productId" />

        <div>
          <label class="text-sm font-medium">Name</label>
          <input id="name" required class="mt-1 w-full border rounded p-2" />
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="text-sm font-medium">Price (INR)</label>
            <input id="price" type="number" min="0" required class="mt-1 w-full border rounded p-2" />
          </div>
          <div>
            <label class="text-sm font-medium">Category</label>
            <input id="category" class="mt-1 w-full border rounded p-2" />
          </div>
        </div>

        <div>
          <label class="text-sm font-medium">Description</label>
          <textarea id="description" rows="3" class="mt-1 w-full border rounded p-2"></textarea>
        </div>

        <div>
          <label class="text-sm font-medium">Image</label>
          <input id="image" type="file" accept="image/*" class="mt-1 w-full" />
          <p class="text-xs text-slate-500 mt-1">Leave empty to keep existing image.</p>

          <div id="previewWrap" class="mt-3 hidden">
            <p class="text-xs text-slate-600 mb-1">Preview</p>
            <img id="previewImg" class="w-36 h-36 object-cover rounded-md border" />
          </div>
        </div>

        <div class="flex items-center gap-3">
          <button id="submitBtn" class="bg-emerald-600 text-white px-4 py-2 rounded">
            Save Product
          </button>
          <button id="resetBtn" type="button" class="border px-4 py-2 rounded">
            Reset
          </button>
          <div id="formMsg" class="text-sm"></div>
        </div>
      </form>
    </section>

    <!-- PRODUCTS LIST -->
    <section class="bg-white p-6 rounded-2xl shadow-sm">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold">Products</h2>
        <input id="search" type="search" placeholder="Search..." class="border rounded p-2 text-sm" />
      </div>

      <div id="productsWrap" class="grid gap-4">
        <div class="text-sm text-slate-500">Loading products…</div>
      </div>
    </section>

    <!-- ORDERS -->
    <section class="bg-white p-6 rounded-2xl shadow-sm lg:col-span-2">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold">Orders</h2>
        <button id="refreshOrders" class="text-sm text-slate-600 hover:underline">Refresh Orders</button>
      </div>

      <div class="overflow-x-auto">
        <table class="w-full text-left text-sm">
          <thead class="bg-slate-100">
            <tr>
              <th class="p-3">Order ID</th>
              <th class="p-3">Subtotal</th>
              <th class="p-3">Created</th>
              <th class="p-3">Actions</th>
            </tr>
          </thead>
          <tbody id="ordersTable">
            <tr><td class="p-3 text-slate-500" colspan="4">No orders loaded yet.</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- USERS SECTION -->
    <section class="bg-white p-6 rounded-2xl shadow-sm lg:col-span-2">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold">Users</h2>
        <button id="refreshUsers" class="text-sm text-slate-600 hover:underline">Refresh Users</button>
      </div>

      <div class="overflow-x-auto">
        <table class="w-full text-left text-sm">
          <thead class="bg-slate-100">
            <tr>
              <th class="p-3">User ID</th>
              <th class="p-3">Name</th>
              <th class="p-3">Email</th>
              <th class="p-3">Created</th>
            </tr>
          </thead>
          <tbody id="usersTable">
            <tr><td class="p-3 text-slate-500" colspan="4">No users loaded yet.</td></tr>
          </tbody>
        </table>
      </div>
    </section>

  </main>

  <footer class="max-w-6xl mx-auto px-6 py-6 text-center text-xs text-slate-500">
    Feastery Admin • API: <span id="apiUrlDisplay">http://localhost:5000</span>
  </footer>

  <!-- SCRIPTS -->
  <script>
    /* ------------------------------
       BASIC SETUP
    ------------------------------ */
    const API = "";
    document.getElementById("apiUrlDisplay").textContent = API;

    const usersTable = document.getElementById("usersTable");
    const refreshUsers = document.getElementById("refreshUsers");
    const ordersTable = document.getElementById("ordersTable");
    const refreshOrders = document.getElementById("refreshOrders");
    const refreshBtn = document.getElementById("refreshBtn");

    const productForm = document.getElementById("productForm");
    const nameEl = document.getElementById("name");
    const priceEl = document.getElementById("price");
    const catEl = document.getElementById("category");
    const descEl = document.getElementById("description");
    const imageEl = document.getElementById("image");
    const previewWrap = document.getElementById("previewWrap");
    const previewImg = document.getElementById("previewImg");
    const productsWrap = document.getElementById("productsWrap");
    const formMsg = document.getElementById("formMsg");
    const submitBtn = document.getElementById("submitBtn");
    const resetBtn = document.getElementById("resetBtn");
    const productIdEl = document.getElementById("productId");
    const formTitle = document.getElementById("formTitle");
    const searchEl = document.getElementById("search");

    let productsCache = [];

    /* ------------------------------
       IMAGE PREVIEW
    ------------------------------ */
    function showPreview(file) {
      if (!file) return previewWrap.classList.add("hidden");
      const url = URL.createObjectURL(file);
      previewImg.src = url;
      previewWrap.classList.remove("hidden");
    }
    imageEl.addEventListener("change", e => showPreview(e.target.files[0]));

    /* ------------------------------
       RESET FORM
    ------------------------------ */
    function resetForm() {
      productIdEl.value = "";
      nameEl.value = "";
      priceEl.value = "";
      catEl.value = "";
      descEl.value = "";
      imageEl.value = "";
      previewWrap.classList.add("hidden");
      formTitle.textContent = "Add New Product";
      formMsg.textContent = "";
    }
    resetBtn.addEventListener("click", resetForm);

    /* ------------------------------
       LOAD PRODUCTS
    ------------------------------ */
    async function loadProducts() {
      productsWrap.innerHTML =
        '<div class="p-4 text-sm text-slate-600">Loading products…</div>';

      try {
        const res = await fetch(`${API}/products/all`);
        const json = await res.json();
        if (!json.success) throw new Error(json.error);

        productsCache = json.products || [];
        renderProducts(productsCache);
      } catch (err) {
        productsWrap.innerHTML =
          `<div class="text-red-600 p-4">${err.message}</div>`;
      }
    }

    function renderProducts(list) {
      if (!list.length)
        return (productsWrap.innerHTML =
          '<div class="p-4 text-slate-500">No products yet.</div>');

      productsWrap.innerHTML = list
        .map(
          p => `
        <div class="card p-4 rounded-lg border flex gap-4" data-id="${p._id}">
          <img src="${API}/uploads/${p.image}" class="w-28 h-28 object-cover rounded-md" />

          <div class="flex-1">
            <div class="flex justify-between">
              <div>
                <div class="font-semibold">${p.name}</div>
                <div class="text-xs text-slate-500">${p.category ?? ""}</div>
              </div>
              <div class="text-right">
                <div class="font-bold text-emerald-600">₹${p.price}</div>
                <div class="text-xs">${p._id}</div>
              </div>
            </div>

            <p class="text-sm mt-2">${p.description ?? ""}</p>

            <div class="mt-3 flex gap-2">
              <button class="editBtn bg-slate-100 px-3 py-1 rounded" data-id="${p._id}">
                Edit
              </button>
              <button class="deleteBtn bg-red-600 text-white px-3 py-1 rounded" data-id="${p._id}">
                Delete
              </button>
            </div>
          </div>
        </div>
        `
        )
        .join("");

      document.querySelectorAll(".deleteBtn").forEach(b =>
        b.addEventListener("click", onDelete)
      );
      document.querySelectorAll(".editBtn").forEach(b =>
        b.addEventListener("click", onEdit)
      );
    }

    /* ------------------------------
       DELETE PRODUCT
    ------------------------------ */
    async function onDelete(e) {
      const id = e.target.dataset.id;
      if (!confirm("Delete this product?")) return;

      await fetch(`${API}/products/${id}`, { method: "DELETE" });
      loadProducts();
    }

    /* ------------------------------
       EDIT PRODUCT
    ------------------------------ */
    function onEdit(e) {
      const id = e.target.dataset.id;
      const p = productsCache.find(x => x._id === id);
      if (!p) return;

      productIdEl.value = p._id;
      nameEl.value = p.name;
      priceEl.value = p.price;
      catEl.value = p.category;
      descEl.value = p.description;

      previewImg.src = `${API}/uploads/${p.image}`;
      previewWrap.classList.remove("hidden");

      formTitle.textContent = "Edit Product";
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    /* ------------------------------
       SAVE PRODUCT (ADD / EDIT)
    ------------------------------ */
    productForm.addEventListener("submit", async e => {
      e.preventDefault();
      submitBtn.disabled = true;

      const id = productIdEl.value;
      const file = imageEl.files[0];

      const fd = new FormData();
      fd.append("name", nameEl.value);
      fd.append("price", priceEl.value);
      fd.append("category", catEl.value);
      fd.append("description", descEl.value);
      if (file) fd.append("image", file);

      const url = id ? `${API}/products/${id}` : `${API}/products/add`;
      const method = id ? "PUT" : "POST";

      try {
        const res = await fetch(url, { method, body: fd });
        const json = await res.json();
        if (!json.success) throw new Error(json.error);

        formMsg.textContent = "Saved!";
        resetForm();
        loadProducts();
      } catch (err) {
        formMsg.textContent = err.message;
      }

      submitBtn.disabled = false;
    });

    /* ------------------------------
       SEARCH PRODUCTS
    ------------------------------ */
    searchEl.addEventListener("input", () => {
      const q = searchEl.value.toLowerCase();
      const filtered = productsCache.filter(
        p =>
          p.name.toLowerCase().includes(q) ||
          p.category?.toLowerCase().includes(q)
      );
      renderProducts(filtered);
    });

    /* ------------------------------
       LOAD ORDERS
    ------------------------------ */
    async function loadOrders() {
      ordersTable.innerHTML =
        '<tr><td class="p-3 text-slate-500" colspan="4">Loading…</td></tr>';

      try {
        const res = await fetch(`${API}/orders/all`);
        const json = await res.json();
        if (!json.success) throw new Error(json.error);

        if (!json.orders.length)
          return (ordersTable.innerHTML =
            '<tr><td class="p-3 text-slate-500" colspan="4">No orders.</td></tr>');

        ordersTable.innerHTML = json.orders
          .map(
            o => `
          <tr class="border-b">
            <td class="p-3 text-xs">${o._id}</td>
            <td class="p-3">₹${o.subtotal}</td>
            <td class="p-3 text-xs">${new Date(o.createdAt).toLocaleString()}</td>
            <td class="p-3">
              <button class="deleteOrderBtn bg-red-600 text-white px-3 py-1 rounded" data-id="${o._id}">
                Delete
              </button>
            </td>
          </tr>`
          )
          .join("");

        document.querySelectorAll(".deleteOrderBtn").forEach(btn =>
          btn.addEventListener("click", async e => {
            const id = e.target.dataset.id;
            if (!confirm("Delete order?")) return;

            await fetch(`${API}/orders/${id}`, { method: "DELETE" });
            loadOrders();
          })
        );
      } catch (err) {
        ordersTable.innerHTML = `<tr><td class="p-3 text-red-600">${err.message}</td></tr>`;
      }
    }

    /* ------------------------------
       LOAD USERS
    ------------------------------ */
    async function loadUsers() {
      usersTable.innerHTML =
        '<tr><td class="p-3 text-slate-500" colspan="4">Loading users…</td></tr>';

      try {
        const res = await fetch(`${API}/users/all`);
        const json = await res.json();
        if (!json.success) throw new Error(json.error);

        if (!json.users.length)
          return (usersTable.innerHTML =
            '<tr><td class="p-3 text-slate-500" colspan="4">No users found.</td></tr>');

        usersTable.innerHTML = json.users
          .map(
            u => `
          <tr class="border-b">
            <td class="p-3">${u._id}</td>
            <td class="p-3">${u.name ?? "—"}</td>
            <td class="p-3">${u.email}</td>
            <td class="p-3 text-xs">${new Date(u.createdAt).toLocaleString()}</td>
          </tr>`
          )
          .join("");
      } catch (err) {
        usersTable.innerHTML =
          `<tr><td class="p-3 text-red-600">${err.message}</td></tr>`;
      }
    }

    /* ------------------------------
       REFRESH BUTTONS
    ------------------------------ */
    refreshBtn.addEventListener("click", loadProducts);
    refreshOrders.addEventListener("click", loadOrders);
    refreshUsers.addEventListener("click", loadUsers);

    /* ------------------------------
       BOOT
    ------------------------------ */
    loadProducts();
    loadOrders();
    loadUsers();
  </script>
</body>
</html>
